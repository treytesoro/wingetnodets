<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Wingetnode repository administration</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <style>
        @font-face {
            font-family: SpartanMB;
            src: url('SpartanMB-Regular.otf') format('truetype');
            font-weight: normal;
        }

        @font-face {
            font-family: SpartanMB;
            src: url('SpartanMB-Bold.otf') format('truetype');
            font-weight: bold;
        }

        @font-face {
            font-family: Montserrat;
            src: url('Montserrat-Regular.otf') format('truetype');
            font-weight: normal;
        }

        @font-face {
            font-family: Montserrat;
            src: url('Montserrat-Bold.otf') format('truetype');
            font-weight: bold;
        }

        @font-face {
            font-family: Montserrat;
            src: url('Montserrat-Italic.otf') format('truetype');
            font-weight: normal;
            font-style: italic;
        }

        @font-face {
            font-family: Montserrat;
            src: url('Montserrat-BoldItalic.otf') format('truetype');
            font-weight: bold;
            font-style: italic;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgb(33, 41, 53);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 150%;
        }

        .content {
            display: flex;
            flex-direction: column;
            width: 80%;
            min-width: 800px;
            max-width: 1000px;
            border-radius: 10px;
            ;
            padding: 20px;
            background-color: white;
        }

        .inputfield {
            margin: 2px;
        }

        .inputfield label {
            display: inline-block;
            min-width: 250px;
            max-width: 250px;
            text-align: right;
            margin: 0px 10px;
        }

        .badpass {
            border-color: red;
        }

        h4 {
            color: rgb(62, 96, 148)
        }

        #btncreatecerts {
            margin-right: 80px;
            min-width: 80px;
            min-height: 40px;
        }

        input[type=text] {
            width: 30em;
        }

        #linksdescription {
            text-align: right;
        }

        #linksdescription table {
            float: right;
            border: solid 0px #cccccc;
            border-collapse: collapse;
        }

        #linksdescription table td {
            /* border: solid 1px #cccccc; */
            border-collapse: collapse;
            padding: 2px 4px;
        }

        #linksdescription td.porttype {
            border-right: solid 1px #cccccc;
            width: 50%;
            text-align: right;
        }

        #linksdescription td.serverlink {
            width: 50%;
            text-align: left;
        }

        .setbtn {
            margin: 4px;
        }

        input[readonly=true][type=text],
        input[readonly][type=text] {
            color: #555555;
            background-color: #cccccc;
            border: solid 2px #cccccc;
            outline: none;
        }

        #manifesteditscrollpanel {
            margin: 10px 0px;
            max-height: 30em;
            min-height: 2em;
            overflow: auto;
            border: solid 1px #cccccc;
        }

        #manifestedit {
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
        }

        .itempanel {
            border: solid 1px #cccccc;
            border-radius: 10px;
            margin: 2px 10px;
            padding: 10px 20px;
        }

        .itempanel h4 {
            margin: 0;
        }

        #gencertpanel {
            display: none;
        }

        #ctrlpanel {
            display: block;
            top: 0px;
            position: sticky;
            flex-basis: 100%;
            margin: 20px 10px;
            background-color: #cccccc;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div class="content">
        <!--validurls-->
        <h2>Welcome to your WingetNode's Repository.</h2>

        <div style="margin-bottom: 6em">
            <h2>Inspect and add a new package:</h2>
            <label for="packagetype">Type: </label>
            <select id="packagetype">
                <option value="msi" selected>MSI</option>
                <option value="msix">MSIX</option>
                <option value="exe">EXE (example: msi bundle/nullsoft)</option>
            </select>
            <!-- <label for="packageurl">Enter package url:</label> -->
            <input type="text" id="packageurl" value="" placeholder="Enter package URL" />
            <button id="inspectbtn">Inspect</button>

            <div id="manifesteditscrollpanel">
                <div id="manifestedit">
                    <!-- Generated elements go here -->
                </div>
            </div>

        </div>

        <div id="packagespanel">
            <button id="getpackages">Show Packages</button>
            <table id="packagestable">
                <thead>

                </thead>
                <tbody id="packagesbody">

                </tbody>
            </table>
        </div>

        <div id="helppanel" style="background-color: #dddddd; border-radius: 6px; padding: 10px;">
            <div>
                You can use the following powershell scripts locally to inspect/upload packages manifests.
            </div>
            <br/>
            <div style="font-weight: bold;"><a href="/getpowershells">Download Powershell Helper files</a></div>
            <br/>
            <div>
                Use the powershell scripts to inspect packages and upload package manifests.<br />
                Extract the zip file and edit <span style="font-weight: bold;">parserconfig.json</span>.<br />
                Set <span style="font-weight: bold;">hostname</span> and <span style="font-weight: bold;">port</span> to
                your wingetnode server's host and port.
                <br />
                <pre>
                    <span style="display: inline-block; border:solid 1px #999999; padding: 10px;">"ingestpackageURI": "https://hostname:port/api/package"</span>
                </pre>
            </div>
            <hr/>
            <div>
                More information can be found at this project repository: <a
                    href="https://github.com/treytesoro/wingetnodets">WingetnodeTS Github</a>
            </div>
        </div>

        <div id="gencertpanel">
            <hr />
            <h3>Generate certificates</h3>
            <div>
                You appear to be visiting this page insecured. If you have not already done so, install a trusted
                certificate for winget
                to function properly.<br />

            </div>
            <div>For testing purposes, generate self-signed certificates to enable your servers HTTPS server.</div>
            <h4>Certificate Authority details</h4>
            <div class="inputfield">
                <label for="countrycode">Country:</label>
                <select id="countrycode">
                    <option value="AD">AD</option>
                    <option value="AE">AE</option>
                    <option value="AF">AF</option>
                    <option value="AG">AG</option>
                    <option value="AI">AI</option>
                    <option value="AL">AL</option>
                    <option value="AM">AM</option>
                    <option value="AO">AO</option>
                    <option value="AQ">AQ</option>
                    <option value="AR">AR</option>
                    <option value="AS">AS</option>
                    <option value="AT">AT</option>
                    <option value="AU">AU</option>
                    <option value="AW">AW</option>
                    <option value="AX">AX</option>
                    <option value="AZ">AZ</option>
                    <option value="BA">BA</option>
                    <option value="BB">BB</option>
                    <option value="BD">BD</option>
                    <option value="BE">BE</option>
                    <option value="BF">BF</option>
                    <option value="BG">BG</option>
                    <option value="BH">BH</option>
                    <option value="BI">BI</option>
                    <option value="BJ">BJ</option>
                    <option value="BL">BL</option>
                    <option value="BM">BM</option>
                    <option value="BN">BN</option>
                    <option value="BO">BO</option>
                    <option value="BQ">BQ</option>
                    <option value="BR">BR</option>
                    <option value="BS">BS</option>
                    <option value="BT">BT</option>
                    <option value="BV">BV</option>
                    <option value="BW">BW</option>
                    <option value="BY">BY</option>
                    <option value="BZ">BZ</option>
                    <option value="CA">CA</option>
                    <option value="CC">CC</option>
                    <option value="CD">CD</option>
                    <option value="CF">CF</option>
                    <option value="CG">CG</option>
                    <option value="CH">CH</option>
                    <option value="CI">CI</option>
                    <option value="CK">CK</option>
                    <option value="CL">CL</option>
                    <option value="CM">CM</option>
                    <option value="CN">CN</option>
                    <option value="CO">CO</option>
                    <option value="CR">CR</option>
                    <option value="CU">CU</option>
                    <option value="CV">CV</option>
                    <option value="CW">CW</option>
                    <option value="CX">CX</option>
                    <option value="CY">CY</option>
                    <option value="CZ">CZ</option>
                    <option value="DE">DE</option>
                    <option value="DJ">DJ</option>
                    <option value="DK">DK</option>
                    <option value="DM">DM</option>
                    <option value="DO">DO</option>
                    <option value="DZ">DZ</option>
                    <option value="EC">EC</option>
                    <option value="EE">EE</option>
                    <option value="EG">EG</option>
                    <option value="EH">EH</option>
                    <option value="ER">ER</option>
                    <option value="ES">ES</option>
                    <option value="ET">ET</option>
                    <option value="FI">FI</option>
                    <option value="FJ">FJ</option>
                    <option value="FK">FK</option>
                    <option value="FM">FM</option>
                    <option value="FO">FO</option>
                    <option value="FR">FR</option>
                    <option value="GA">GA</option>
                    <option value="GB">GB</option>
                    <option value="GD">GD</option>
                    <option value="GE">GE</option>
                    <option value="GF">GF</option>
                    <option value="GG">GG</option>
                    <option value="GH">GH</option>
                    <option value="GI">GI</option>
                    <option value="GL">GL</option>
                    <option value="GM">GM</option>
                    <option value="GN">GN</option>
                    <option value="GP">GP</option>
                    <option value="GQ">GQ</option>
                    <option value="GR">GR</option>
                    <option value="GS">GS</option>
                    <option value="GT">GT</option>
                    <option value="GU">GU</option>
                    <option value="GW">GW</option>
                    <option value="GY">GY</option>
                    <option value="HK">HK</option>
                    <option value="HM">HM</option>
                    <option value="HN">HN</option>
                    <option value="HR">HR</option>
                    <option value="HT">HT</option>
                    <option value="HU">HU</option>
                    <option value="ID">ID</option>
                    <option value="IE">IE</option>
                    <option value="IL">IL</option>
                    <option value="IM">IM</option>
                    <option value="IN">IN</option>
                    <option value="IO">IO</option>
                    <option value="IQ">IQ</option>
                    <option value="IR">IR</option>
                    <option value="IS">IS</option>
                    <option value="IT">IT</option>
                    <option value="JE">JE</option>
                    <option value="JM">JM</option>
                    <option value="JO">JO</option>
                    <option value="JP">JP</option>
                    <option value="KE">KE</option>
                    <option value="KG">KG</option>
                    <option value="KH">KH</option>
                    <option value="KI">KI</option>
                    <option value="KM">KM</option>
                    <option value="KN">KN</option>
                    <option value="KP">KP</option>
                    <option value="KR">KR</option>
                    <option value="KW">KW</option>
                    <option value="KY">KY</option>
                    <option value="KZ">KZ</option>
                    <option value="LA">LA</option>
                    <option value="LB">LB</option>
                    <option value="LC">LC</option>
                    <option value="LI">LI</option>
                    <option value="LK">LK</option>
                    <option value="LR">LR</option>
                    <option value="LS">LS</option>
                    <option value="LT">LT</option>
                    <option value="LU">LU</option>
                    <option value="LV">LV</option>
                    <option value="LY">LY</option>
                    <option value="MA">MA</option>
                    <option value="MC">MC</option>
                    <option value="MD">MD</option>
                    <option value="ME">ME</option>
                    <option value="MF">MF</option>
                    <option value="MG">MG</option>
                    <option value="MH">MH</option>
                    <option value="MK">MK</option>
                    <option value="ML">ML</option>
                    <option value="MM">MM</option>
                    <option value="MN">MN</option>
                    <option value="MO">MO</option>
                    <option value="MP">MP</option>
                    <option value="MQ">MQ</option>
                    <option value="MR">MR</option>
                    <option value="MS">MS</option>
                    <option value="MT">MT</option>
                    <option value="MU">MU</option>
                    <option value="MV">MV</option>
                    <option value="MW">MW</option>
                    <option value="MX">MX</option>
                    <option value="MY">MY</option>
                    <option value="MZ">MZ</option>
                    <option value="NA">NA</option>
                    <option value="NC">NC</option>
                    <option value="NE">NE</option>
                    <option value="NF">NF</option>
                    <option value="NG">NG</option>
                    <option value="NI">NI</option>
                    <option value="NL">NL</option>
                    <option value="NO">NO</option>
                    <option value="NP">NP</option>
                    <option value="NR">NR</option>
                    <option value="NU">NU</option>
                    <option value="NZ">NZ</option>
                    <option value="OM">OM</option>
                    <option value="PA">PA</option>
                    <option value="PE">PE</option>
                    <option value="PF">PF</option>
                    <option value="PG">PG</option>
                    <option value="PH">PH</option>
                    <option value="PK">PK</option>
                    <option value="PL">PL</option>
                    <option value="PM">PM</option>
                    <option value="PN">PN</option>
                    <option value="PR">PR</option>
                    <option value="PS">PS</option>
                    <option value="PT">PT</option>
                    <option value="PW">PW</option>
                    <option value="PY">PY</option>
                    <option value="QA">QA</option>
                    <option value="RE">RE</option>
                    <option value="RO">RO</option>
                    <option value="RS">RS</option>
                    <option value="RU">RU</option>
                    <option value="RW">RW</option>
                    <option value="SA">SA</option>
                    <option value="SB">SB</option>
                    <option value="SC">SC</option>
                    <option value="SD">SD</option>
                    <option value="SE">SE</option>
                    <option value="SG">SG</option>
                    <option value="SH">SH</option>
                    <option value="SI">SI</option>
                    <option value="SJ">SJ</option>
                    <option value="SK">SK</option>
                    <option value="SL">SL</option>
                    <option value="SM">SM</option>
                    <option value="SN">SN</option>
                    <option value="SO">SO</option>
                    <option value="SR">SR</option>
                    <option value="SS">SS</option>
                    <option value="ST">ST</option>
                    <option value="SV">SV</option>
                    <option value="SX">SX</option>
                    <option value="SY">SY</option>
                    <option value="SZ">SZ</option>
                    <option value="TC">TC</option>
                    <option value="TD">TD</option>
                    <option value="TF">TF</option>
                    <option value="TG">TG</option>
                    <option value="TH">TH</option>
                    <option value="TJ">TJ</option>
                    <option value="TK">TK</option>
                    <option value="TL">TL</option>
                    <option value="TM">TM</option>
                    <option value="TN">TN</option>
                    <option value="TO">TO</option>
                    <option value="TR">TR</option>
                    <option value="TT">TT</option>
                    <option value="TV">TV</option>
                    <option value="TW">TW</option>
                    <option value="TZ">TZ</option>
                    <option value="UA">UA</option>
                    <option value="UG">UG</option>
                    <option value="UM">UM</option>
                    <option value="US">US</option>
                    <option value="UY">UY</option>
                    <option value="UZ">UZ</option>
                    <option value="VA">VA</option>
                    <option value="VC">VC</option>
                    <option value="VE">VE</option>
                    <option value="VG">VG</option>
                    <option value="VI">VI</option>
                    <option value="VN">VN</option>
                    <option value="VU">VU</option>
                    <option value="WF">WF</option>
                    <option value="WS">WS</option>
                    <option value="YE">YE</option>
                    <option value="YT">YT</option>
                    <option value="ZA">ZA</option>
                    <option value="ZM">ZM</option>
                    <option value="ZW">ZW</option>
                </select>
            </div>
            <div class="inputfield">
                <label for="locality">Locality:</label>
                <input type="text" id="locality" />
            </div>
            <div class="inputfield">
                <label for="organization">Organization:</label>
                <input type="text" id="organization" />
            </div>
            <div class="inputfield">
                <label for="cacn">Common name:</label>
                <input type="text" id="cacn" />
            </div>
            <div class="inputfield">
                <label for="caemail">Email address:</label>
                <input type="text" id="caemail" />
            </div>
            <div class="inputfield">
                <label for="challengepwd1">Challenge password:</label>
                <input type="password" id="challengepwd1" />
            </div>
            <div class="inputfield">
                <label for="challengepwd2">Challenge password (verify):</label>
                <input type="password" id="challengepwd2" />
            </div>

            <h4>Web server certificate details</h4>
            <div class="inputfield">
                <label for="san">Subject Alternate names:</label>
                <input type="text" id="san" /> (comma delimited list of names)
            </div>
            <div style="text-align: right; position: relative">
                <div style="text-align: left; left: 50%; width: 50%; margin: 20px; font-size: .85em;">
                    Clicking create will create and enable certificates
                    for your webserver. A zip file will download containing
                    your server's Certificate Authority and webserver certficates.
                    A PFX file is included and can be used to add the
                    Certificate Authority to your list of Trusted Root Certificate Authorities.
                </div>
                <button id="btncreatecerts">Create</button>
            </div>
        </div>
    </div>
    <script>
        // DO NOT EDIT these 3 lines!
        //{HOSTNAME}
        //{PORT}
        //{SSLPORT}
        document.addEventListener('DOMContentLoaded', () => {
            if (location.protocol !== 'https:') {
                document.querySelector("#gencertpanel").style.display = 'block';
            }
            init();
            
        });

        var init = () => {
            //var x = document.getElementById('');
            var btncreatecerts = document.getElementById('btncreatecerts');
            var capw1 = document.getElementById('challengepwd1');
            var capw2 = document.getElementById('challengepwd2');
            var countrycode = document.getElementById('countrycode');
            var locality = document.getElementById('locality');
            var organization = document.getElementById('organization');
            var cacn = document.getElementById('cacn');
            var caemail = document.getElementById('caemail');
            var san = document.getElementById('san');
            var inspectbtn = document.getElementById("inspectbtn");
            var packageurl = document.getElementById("packageurl");
            var manifestedit = document.getElementById("manifestedit");
            var packagetype = document.getElementById("packagetype");
            var getpackages = document.getElementById("getpackages");

            var getcerts = () => {
                console.log("Getting certs");

                let reqData = {
                    countrycode: countrycode.value,
                    locality: locality.value,
                    organization: organization.value,
                    cacn: cacn.value,
                    caemail: caemail.value,
                    capw: capw1.value,
                    san: san.value
                };

                let xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {

                        console.log('ok');
                        console.log(xhttp.response);
                        let blob = new Blob([xhttp.response], { type: "application/zip" });
                        var a = document.createElement("a");
                        document.body.appendChild(a);
                        a.style = "display:none";
                        var url = window.URL.createObjectURL(blob);
                        a.href = url;
                        a.download = "newcerts.zip";
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    }

                    if (this.readyState == 4 && this.status == 204) {
                        alert("Unsupported host OS!");
                    }
                }
                xhttp.responseType = "blob";
                xhttp.open("POST", "/getcerts");
                xhttp.setRequestHeader(
                    "Content-type",
                    "application/json"
                );
                xhttp.send(JSON.stringify(reqData));
            }

            btncreatecerts.addEventListener('click', getcerts);

            [capw1, capw2].forEach(capw => {
                capw.addEventListener('keyup', (e) => {
                    passmatch(e);
                });
            });

            var passmatch = (e) => {
                let ismatch = capw1.value == capw2.value;
                if (!ismatch) {
                    capw1.classList.add('badpass');
                    capw2.classList.add('badpass');
                }
                else {
                    capw1.classList.remove('badpass');
                    capw2.classList.remove('badpass');
                }
                return ismatch;
            }

            //var eventhandlers = [];

            var _getpackages = () => {
                packagesbody.replaceChildren();
                fetch("/api/getpackages", {
                    "method": "POST",
                    "headers": {
                        "Content-Type": "application/json"
                    },
                    "body": JSON.stringify({ filter: "" })
                }).then(async response => {
                    let obj = await response.json();
                    console.log(obj);
                    let packagesbody = document.getElementById('packagesbody');
                    for (item in obj) {
                        let tr = document.createElement('tr');
                        let tdpkgid = document.createElement('td');
                        let tdpkgname = document.createElement('td');
                        let tdpkgpublisher = document.createElement('td');
                        let tdpkgversion = document.createElement('td');
                        tdpkgid.innerText = obj[item]['PackageIdentifier']
                        tdpkgname.innerText = obj[item]['PackageName'];
                        tdpkgpublisher.innerText = obj[item]['Publisher'];
                        tdpkgversion.innerText = obj[item]['PackageVersion'];
                        tr.appendChild(tdpkgid);
                        tr.appendChild(tdpkgname);
                        tr.appendChild(tdpkgpublisher);
                        tr.appendChild(tdpkgversion);
                        packagesbody.appendChild(tr);
                    }
                }).catch(err => {
                    console.log(err);
                });
            }

            getpackages.addEventListener('click', async (e)=>{
                _getpackages();
            });

            var currentmanifest = null;
            inspectbtn.addEventListener('click', (e) => {
                //let handlers = eventhandlers;
                manifestedit.innerHTML = "";
                currentmanifest = null;
                fetch("/inspectmsi", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ packageurl: packageurl.value, packagetype: packagetype.value })
                }).then(response => {
                    if (response.status == 200) {
                        response.json().then(jobj => {
                            //let _html = "";

                            currentmanifest = jobj;

                            function setval() {

                            }

                            function unsetval() {
                                // console.log(ref);
                                // console.log(propname);
                                // console.log(parent);
                                // console.log(input.value);
                                input.removeAttribute('readonly');
                                input.readOnly = false;
                                //ref[propname] = input.value;
                                console.log(currentmanifest);
                                e.target.remove();

                                let btn = document.createElement('button');
                                btn.classList.add("setbtn")
                                btn.setAttribute('id', prop + "_btn");
                                btn.innerText = "Set";
                                div.appendChild(btn);
                                let ref = obj;
                                let propname = prop;
                                btn.addEventListener('click', function (event) {
                                    // console.log(ref);
                                    // console.log(propname);
                                    // console.log(parent);
                                    // console.log(input.value);
                                    ref[propname] = input.value;
                                    console.log(currentmanifest);
                                });
                            }

                            let level = 1;
                            function iterateobj(obj) {
                                let parent = null;
                                if (arguments[1]) {
                                    parent = arguments[1];
                                }
                                console.log(level);
                                for (prop in obj) {
                                    // string type: we can create an input field for the single type
                                    if (typeof obj[prop] == 'string') {
                                        let div = document.createElement('div');
                                        div.setAttribute('class', 'itempanel');
                                        let h4 = document.createElement('h4');
                                        h4.innerText = prop;
                                        let input = document.createElement('input');
                                        input.value = obj[prop];
                                        input.type = "text";
                                        div.appendChild(h4);
                                        div.appendChild(input);

                                        let ref = obj;
                                        let propname = prop;
                                        let unsetbtn = document.createElement('button');
                                        unsetbtn.classList.add("setbtn")
                                        unsetbtn.setAttribute('id', prop + "_btn");
                                        unsetbtn.innerText = "UnSet";
                                        div.appendChild(unsetbtn);
                                        unsetbtn.addEventListener('click', function (event) {
                                            input.removeAttribute('readonly');
                                            input.readOnly = false;
                                        });

                                        let setbtn = document.createElement('button');
                                        setbtn.classList.add("setbtn")
                                        setbtn.setAttribute('id', prop + "_btn");
                                        setbtn.innerText = "Set";
                                        div.appendChild(setbtn);
                                        setbtn.addEventListener('click', function (event) {
                                            input.setAttribute('readonly', 'true');
                                            input.readOnly = true;

                                            ref[propname] = input.value;
                                            console.log(currentmanifest);
                                        });

                                        // Set default for no value
                                        // Only create button and allow input 
                                        // edit when initial value is empty.
                                        if (input.value.trim() != "") {
                                            input.setAttribute('readonly', 'true');
                                            input.readOnly = true;
                                        }

                                        // Add the string input's parent div panel
                                        // to the main manifestedit div
                                        manifestedit.appendChild(div);
                                    }
                                    // object type: This will recursively call this
                                    // method to generate our fields.
                                    if (typeof obj[prop] == 'object') {
                                        let isArray = obj[prop].length !== undefined ? true : false;
                                        // Check for keys and iterate this child object if needed
                                        let keylength = Object.keys(obj[prop]).length;
                                        if (keylength > 0) {
                                            // found keys so iterate them
                                            for (item in obj[prop]) {
                                                let newobj = obj[prop][item];
                                                level++;
                                                iterateobj(newobj, obj[prop]);
                                            }
                                        }
                                        else if (isArray) {
                                            if (prop == "Tags") {
                                                let div = document.createElement('div');
                                                div.setAttribute('class', 'itempanel');
                                                let h4 = document.createElement('h4');
                                                h4.innerText = prop;
                                                let input = document.createElement('input');
                                                input.type = "text";
                                                input.value = "";

                                                let btn = document.createElement('button');
                                                btn.setAttribute('id', prop + "_btn");
                                                btn.innerText = "Add New";

                                                div.appendChild(h4);
                                                div.appendChild(input);
                                                div.appendChild(btn);
                                                manifestedit.appendChild(div);
                                                let ref = obj;
                                                let propname = prop;
                                                btn.addEventListener('click', function (event) {
                                                    // Adds a new key/value pair to the object
                                                    // and creates readonly input fields to display
                                                    // them, with a Remove button to remove the item.
                                                    // console.log(ref);
                                                    // console.log(propname);
                                                    // console.log(parent);
                                                    // console.log(input.value);
                                                    let tagsarray = ref[propname];
                                                    tagsarray.push(input.value);
                                                    //ref[propname][input.value] = input2.value;
                                                    let i1 = document.createElement('input');
                                                    i1.type = "text";
                                                    i1.value = input.value;
                                                    i1.setAttribute('readonly', 'true');

                                                    let d2 = document.createElement('div');
                                                    let b2 = document.createElement('button');
                                                    b2.innerText = "Remove";

                                                    d2.append(i1);
                                                    d2.append(b2);
                                                    // b2's reference to input.value will change when adding a new item.
                                                    // Save the value to the dataset.iv property so we can use it as key
                                                    // when deleting a property from an object.
                                                    //b2.dataset.propname = propname;
                                                    //b2.dataset.iv = input.value;
                                                    b2.propname = propname; // do this instead so not visible in DOM
                                                    b2.iv = input.value;
                                                    b2.addEventListener('click', (e) => {
                                                        //console.log(propname);
                                                        //console.log(input.value);
                                                        //console.log(e.target.iv);
                                                        //delete ref[e.target.propname][e.target.iv];
                                                        d2.remove();
                                                        //let idx_removes = [];
                                                        for (let i = 0; i < ref[e.target.propname].length; i++) {
                                                            if (ref[e.target.propname][i] == e.target.iv) {
                                                                //idx_removes.push(i);
                                                                ref[e.target.propname].splice(i, 1);
                                                            }
                                                        }
                                                        //for()
                                                        console.log(currentmanifest);
                                                    });
                                                    h4.insertAdjacentElement('afterend', d2);
                                                    console.log(currentmanifest);
                                                    input.value = "";
                                                });
                                            }
                                            if (prop == "InstallModes") {
                                                let div = document.createElement('div');
                                                div.setAttribute('class', 'itempanel');
                                                let h4 = document.createElement('h4');
                                                h4.innerText = prop;
                                                let desc = document.createElement('div');
                                                desc.innerText = "Add the install modes supported by the installer.";
                                                let input = document.createElement('select');
                                                let optionsArray = [
                                                    "",
                                                    "silent",
                                                    "silentWithProgress",
                                                    "interactive"
                                                ]
                                                for (let opt in optionsArray) {
                                                    let optionElem = document.createElement('option');
                                                    optionElem.value = optionsArray[opt];
                                                    optionElem.innerText = optionsArray[opt];
                                                    input.appendChild(optionElem);
                                                }

                                                let btn = document.createElement('button');
                                                btn.setAttribute('id', prop + "_btn");
                                                btn.innerText = "Add New";

                                                div.appendChild(h4);
                                                div.appendChild(desc);
                                                div.appendChild(input);
                                                div.appendChild(btn);
                                                manifestedit.appendChild(div);
                                                let ref = obj;
                                                let propname = prop;
                                                btn.addEventListener('click', function (event) {
                                                    // Adds a new key/value pair to the object
                                                    // and creates readonly input fields to display
                                                    // them, with a Remove button to remove the item.
                                                    // console.log(ref);
                                                    // console.log(propname);
                                                    // console.log(parent);
                                                    // console.log(input.value);
                                                    let installmodesarray = ref[propname];
                                                    installmodesarray.push(input.value);
                                                    //ref[propname][input.value] = input2.value;
                                                    let i1 = document.createElement('input');
                                                    i1.type = "text";
                                                    i1.value = input.value;
                                                    i1.setAttribute('readonly', 'true');

                                                    let d2 = document.createElement('div');
                                                    let b2 = document.createElement('button');
                                                    b2.innerText = "Remove";

                                                    d2.append(i1);
                                                    d2.append(b2);
                                                    // b2's reference to input.value will change when adding a new item.
                                                    // Save the value to the dataset.iv property so we can use it as key
                                                    // when deleting a property from an object.
                                                    //b2.dataset.propname = propname;
                                                    //b2.dataset.iv = input.value;
                                                    b2.propname = propname; // do this instead so not visible in DOM
                                                    b2.iv = input.value;
                                                    b2.addEventListener('click', (e) => {
                                                        //console.log(propname);
                                                        //console.log(input.value);
                                                        //console.log(e.target.iv);
                                                        //delete ref[e.target.propname][e.target.iv];
                                                        d2.remove();
                                                        //let idx_removes = [];
                                                        for (let i = 0; i < ref[e.target.propname].length; i++) {
                                                            if (ref[e.target.propname][i] == e.target.iv) {
                                                                //idx_removes.push(i);
                                                                ref[e.target.propname].splice(i, 1);
                                                            }
                                                        }
                                                        //for()
                                                        console.log(currentmanifest);
                                                    });
                                                    h4.insertAdjacentElement('afterend', d2);
                                                    console.log(currentmanifest);
                                                    input.value = "";
                                                });
                                            }
                                        }
                                        else {
                                            if(prop == "InstallerSwitches") {
                                                // no keys found so we create a pair of input fields
                                                // to add a new key and value
                                                let div = document.createElement('div');
                                                div.setAttribute('class', 'itempanel');
                                                let h4 = document.createElement('h4');
                                                h4.innerText = prop;
                                                let desc = document.createElement('div');
                                                desc.innerText = "Installer command line switches (example: /qn /quiet).";
                                                let input = document.createElement('select');
                                                let optionsArray = [
                                                    "",
                                                    "Silent",
                                                    "SilentWithProgress",
                                                    "Interactive",
                                                    "InstallLocation",
                                                    "Log",
                                                    "Upgrade",
                                                    "Custom",
                                                ]
                                                for(let opt in optionsArray) {
                                                    let optionElem = document.createElement('option');
                                                    optionElem.value = optionsArray[opt];
                                                    optionElem.innerText = optionsArray[opt];
                                                    input.appendChild(optionElem);
                                                }
                                                let text = document.createTextNode(" : ");
                                                let input2 = document.createElement('input');
                                                input2.type = "text";
                                                input2.value = "";
                                                let btn = document.createElement('button');
                                                btn.setAttribute('id', prop + "_btn");
                                                btn.innerText = "Add New";
                                                div.appendChild(h4);
                                                div.appendChild(desc);
                                                div.appendChild(input);
                                                div.appendChild(text);
                                                div.appendChild(input2);
                                                div.appendChild(btn);
                                                manifestedit.appendChild(div);
                                                let ref = obj;
                                                let propname = prop;
                                                btn.addEventListener('click', function (event) {
                                                    // Adds a new key/value pair to the object
                                                    // and creates readonly input fields to display
                                                    // them, with a Remove button to remove the item.
                                                    // console.log(ref);
                                                    // console.log(propname);
                                                    // console.log(parent);
                                                    // console.log(input.value);
                                                    ref[propname][input.value] = input2.value;
                                                    let i1 = document.createElement('input');
                                                    i1.type = "text";
                                                    i1.value = input.value;
                                                    i1.setAttribute('readonly', 'true');
                                                    let i2 = document.createElement('input');
                                                    i2.type = "text";
                                                    i2.value = input2.value;
                                                    i2.setAttribute('readonly', 'true');
                                                    let d2 = document.createElement('div');
                                                    let t2 = document.createTextNode(" : ");
                                                    let b2 = document.createElement('button');
                                                    b2.innerText = "Remove";
                                                    d2.append(i1);
                                                    d2.append(t2);
                                                    d2.append(i2);
                                                    d2.append(b2);
                                                    // b2's reference to input.value will change when adding a new item.
                                                    // Save the value to the dataset.iv property so we can use it as key
                                                    // when deleting a property from an object.
                                                    //b2.dataset.propname = propname;
                                                    //b2.dataset.iv = input.value;
                                                    b2.propname = propname; // do this instead so not visible in DOM
                                                    b2.iv = input.value;
                                                    b2.addEventListener('click', (e) => {
                                                        //console.log(propname);
                                                        //console.log(input.value);
                                                        //console.log(e.target.iv);
                                                        delete ref[e.target.propname][e.target.iv];
                                                        d2.remove();
                                                        console.log(currentmanifest);
                                                    });
                                                    h4.insertAdjacentElement('afterend', d2);
                                                    console.log(currentmanifest);
                                                    input.value = "";
                                                    input2.value = "";
                                                });
                                            }
                                        }
                                    }
                                }
                            }

                            let submitbtn = document.createElement("button");
                            submitbtn.setAttribute('id', 'submitpackagebutton');
                            submitbtn.innerText = "Submit Package";
                            submitbtn.addEventListener('click', async (e) => {
                                let response = await fetch('/api/package', {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(currentmanifest)
                                });
                                let responseJson = await response.json();
                                console.log(responseJson);
                                if (responseJson.status == 'error') {
                                    alert(responseJson.errormessage);
                                }
                                else {
                                    alert("PackageManifest added to repository.");
                                    manifestedit.innerHTML = "";
                                    currentmanifest = null;
                                    _getpackages();
                                }
                            });
                            let ctrlpanel = document.createElement('div');
                            ctrlpanel.setAttribute('id', 'ctrlpanel');
                            ctrlpanel.appendChild(submitbtn);
                            manifestedit.appendChild(ctrlpanel);
                            //console.log(currentmanifest);
                            iterateobj(currentmanifest);


                            // for(prop in jobj) {
                            //     console.log(typeof jobj[prop]);
                            //     if(typeof jobj[prop] == 'string') {
                            //         _html += `<div><h4>${prop}</h4><input type='text' value='${jobj[prop]}'</div>`
                            //     }
                            //     if(typeof jobj[prop] == 'object') {
                            //         let obj = jobj[prop];
                            //         if(obj.length) {
                            //             console.log(`LENGTH: ${obj.length}`)
                            //             for(p in obj) {
                            //                 if(typeof obj[p] == "object"){
                            //                     if(obj[p].length) {

                            //                     }
                            //                     else {
                            //                         let obj2 = obj[p];
                            //                         for(p2 in obj2) {
                            //                             _html += `<div><h4>${p2}</h4><input type='text' value='${obj2[p2]}'</div>`
                            //                         }
                            //                     }
                            //                 }
                            //                 if(typeof obj[p] == "string") {
                            //                     _html += `<div><h4>${p}</h4><input type='text' value='${obj[p]}'</div>`
                            //                 }
                            //             }
                            //         }
                            //     }
                            // }
                            //console.log(_html);
                            //manifestedit.innerHTML = _html;
                        });
                    }
                    else if (response.status == 204) {
                        alert("Type currently unsupported");
                    }
                }).catch(err => {});
            });
        }

        function checkbtn(event) {
            console.log(event.target.dataset.obj);
        }
    </script>
</body>

</html>